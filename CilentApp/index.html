<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>ALBUM CEREMONY / ISSUE 091</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@1,900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Âü∫Á§éË®≠ÂÆö */
      body {
        background-color: #ffcc00;
        font-family: "Inter", sans-serif;
        overflow-x: hidden;
        cursor: none;
      }

      /* Ë¶ñË¶∫ÁâπÊïàÂ±§ */
      .noise {
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9998;
        opacity: 0.12;
        mix-blend-mode: multiply;
        background-image: url("https://grainy-gradients.vercel.app/noise.svg");
      }
      .dots {
        position: fixed;
        inset: 0;
        pointer-events: none;
        opacity: 0.2;
        background-image: radial-gradient(circle, #000 1px, transparent 1px);
        background-size: 24px 24px;
        z-index: 1;
      }

      /* ÁéãÁâõÈ¢®Ê†ºÊåâÈàï */
      .gnu-btn {
        position: relative;
        font-weight: 900;
        font-style: italic;
        border: 4px solid #000;
        transition: all 0.1s ease-out;
        text-transform: uppercase;
        user-select: none;
      }
      .gnu-btn-red {
        background-color: #dc2626;
        color: white;
        box-shadow: 8px 8px 0px 0px rgba(0, 0, 0, 1);
      }
      .gnu-btn-red:active {
        box-shadow: 0 0 0 0;
        transform: translate(8px, 8px);
      }
      .gnu-btn-black {
        background-color: #000;
        color: #ffcc00;
        box-shadow: 8px 8px 0px 0px rgba(220, 38, 38, 1);
      }
      .gnu-btn-black:active {
        box-shadow: 0 0 0 0;
        transform: translate(8px, 8px);
      }
      .gnu-btn-white {
        background-color: #fff;
        color: #000;
        box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 1);
      }
      .gnu-btn-white:hover {
        background-color: #000;
        color: #fff;
      }
      .gnu-btn-white:active {
        box-shadow: 0 0 0 0;
        transform: translate(4px, 4px);
      }

      /* Ë°®Ê†ºËàá UI */
      .gnu-table th {
        border-bottom: 6px solid black;
        padding: 15px;
        font-size: 1.2rem;
      }
      .gnu-table td {
        border-bottom: 2px solid black;
        padding: 12px;
        background: rgba(255, 255, 255, 0.8);
        font-weight: 700;
      }
      .gnu-table tr:hover td {
        background: #fff;
        color: #dc2626;
      }
      .modal-bg {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(4px);
      }

      /* Ê∏∏Ê®ô */
      #custom-cursor {
        position: fixed;
        top: 0;
        left: 0;
        width: 48px;
        height: 48px;
        pointer-events: none;
        z-index: 9999;
        will-change: transform;
        transition: opacity 0.2s ease;
        animation: spin 2s linear infinite;
      }
      @keyframes spin {
        from {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      body:has(button:hover, a:hover, input:hover, select:hover, label:hover)
        #custom-cursor {
        opacity: 0;
      }
      button:hover,
      a:hover,
      input:hover,
      select:hover,
      label:hover {
        cursor: default !important;
      }

      /* Alert ÂãïÁï´ */
      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .alert-box {
        animation: slideDown 0.2s ease-out forwards;
      }
    </style>
  </head>
  <body class="p-0 m-0">
    <div class="noise"></div>
    <div class="dots"></div>

    <div id="custom-cursor">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle
          cx="50"
          cy="50"
          r="48"
          fill="black"
          stroke="black"
          stroke-width="2"
        />
        <circle cx="50" cy="50" r="20" fill="#dc2626" />
        <circle cx="50" cy="50" r="6" fill="#ffcc00" />
        <path
          d="M50 10 A40 40 0 0 1 90 50"
          stroke="white"
          stroke-width="2"
          fill="none"
          opacity="0.5"
        />
        <path
          d="M50 90 A40 40 0 0 1 10 50"
          stroke="white"
          stroke-width="2"
          fill="none"
          opacity="0.5"
        />
      </svg>
    </div>

    <div
      id="custom-alert-overlay"
      class="fixed inset-0 modal-bg z-[200] hidden flex items-center justify-center p-4"
    >
      <div
        id="alert-box-content"
        class="alert-box border-[6px] border-black shadow-[20px_20px_0px_0px_rgba(0,0,0,1)] max-w-md w-full p-8 text-center relative"
      >
        <h3 id="alert-title" class="text-4xl font-black italic mb-4 uppercase">
          WARNING
        </h3>
        <p
          id="alert-msg"
          class="text-xl font-bold mb-8 uppercase whitespace-pre-line"
        >
          MESSAGE HERE
        </p>
        <div id="alert-actions" class="flex justify-center gap-4"></div>
      </div>
    </div>

    <div
      id="login-page"
      class="min-h-screen flex items-center justify-center p-4 relative z-50"
    >
      <div
        class="bg-white border-[8px] border-black p-10 shadow-[20px_20px_0px_0px_rgba(220,38,38,1)] w-full max-w-md rotate-[-2deg]"
      >
        <h2
          id="auth-title"
          class="text-6xl font-black italic mb-8 tracking-tighter"
        >
          LOGIN
        </h2>

        <label class="block font-black text-xs mb-1">NICKNAME</label>
        <input
          type="text"
          id="nickname-input"
          placeholder="YOUR NAME"
          class="w-full border-4 border-black p-4 mb-4 text-2xl font-black outline-none focus:bg-[#ffcc00] uppercase"
        />

        <label class="block font-black text-xs mb-1">PASSWORD</label>
        <input
          type="password"
          id="password-input"
          placeholder="***"
          class="w-full border-4 border-black p-4 mb-6 text-2xl font-black outline-none focus:bg-[#ffcc00]"
        />

        <button
          onclick="handleAuth()"
          onmousedown="playBeep(800,400)"
          class="gnu-btn gnu-btn-black w-full py-4 text-3xl mb-4"
        >
          ENTER ‚ñ∂
        </button>

        <div class="text-center border-t-4 border-black pt-4">
          <p id="auth-toggle-text" class="text-sm font-black italic">
            NEW HERE?
          </p>
          <button
            onclick="toggleAuthMode()"
            class="text-red-600 font-black underline text-lg hover:bg-black hover:text-[#ffcc00] px-2 transition"
          >
            CREATE ACCOUNT
          </button>
        </div>
      </div>
    </div>

    <div id="main-page" class="hidden relative z-10">
      <header
        class="bg-black text-[#ffcc00] py-3 px-6 flex justify-between items-center sticky top-0 z-50 border-b-4 border-white"
      >
        <span class="text-xs tracking-[0.4em] font-black"
          >ALBUM CEREMONY / ISSUE 091</span
        >
        <div class="flex items-center gap-4">
          <span
            id="user-display"
            class="text-sm font-black italic bg-white text-black px-2 py-1 rotate-2"
            >GUEST</span
          >
          <button
            onclick="logout()"
            class="text-xs border border-[#ffcc00] px-2 py-1 hover:bg-[#ffcc00] hover:text-black transition"
          >
            LOGOUT
          </button>
        </div>
      </header>

      <main class="max-w-6xl mx-auto p-4 md:p-12">
        <h1 class="text-[6vw] leading-none font-black italic mb-8 uppercase">
          <span class="bg-black text-white px-2">ALBUM</span> Collection
        </h1>

        <div
          class="bg-white border-[6px] border-black p-6 mb-12 shadow-[12px_12px_0px_0px_rgba(0,0,0,1)] rotate-1 relative group"
        >
          <div
            class="absolute -top-4 -left-4 bg-red-600 text-white font-black italic px-4 py-1 border-2 border-black rotate-[-3deg] text-lg"
          >
            QUERY / CONTROL
          </div>
          <div class="flex flex-wrap gap-6 items-end">
            <div class="flex-1 min-w-[200px]">
              <label
                class="block font-black text-sm mb-2 italic bg-black text-white w-max px-2"
                >KEYWORD</label
              >
              <input
                type="text"
                id="search-input"
                class="w-full bg-gray-100 border-b-4 border-black p-2 text-2xl font-black italic outline-none focus:border-red-600 transition-colors"
              />
            </div>
            <div class="w-48">
              <label
                class="block font-black text-sm mb-2 italic bg-black text-white w-max px-2"
                >OWNER</label
              >
              <select
                id="search-owner-select"
                class="w-full bg-gray-100 border-b-4 border-black p-2 text-xl font-black italic outline-none appearance-none rounded-none"
              >
                <option value="ALL">ALL USERS</option>
              </select>
            </div>
            <button
              onclick="resetAndFetch()"
              onmousedown="playBeep(600,800)"
              class="gnu-btn gnu-btn-black px-8 py-3 text-xl"
            >
              SEARCH
            </button>
            <button
              onclick="openModal('create')"
              onmousedown="playBeep(900,1200)"
              class="gnu-btn gnu-btn-red px-8 py-3 text-xl"
            >
              + NEW
            </button>
          </div>
        </div>

        <div
          class="bg-white border-[6px] border-black shadow-[15px_15px_0px_0px_rgba(220,38,38,1)] overflow-hidden mb-8"
        >
          <table class="w-full text-left gnu-table italic">
            <thead class="bg-black text-[#ffcc00]">
              <tr>
                <th class="w-20">ID</th>
                <th>Cover</th>
                <th>Artist / Title</th>
                <th>Year</th>
                <th>Owner</th>
                <th class="text-right">Action</th>
              </tr>
            </thead>
            <tbody id="album-tbody"></tbody>
          </table>
        </div>

        <div class="flex justify-center items-center gap-4 mb-20">
          <button
            onclick="changePage('first')"
            class="gnu-btn gnu-btn-white px-4 py-2 text-lg"
          >
            |&lt;
          </button>
          <button
            onclick="changePage('prev')"
            class="gnu-btn gnu-btn-white px-4 py-2 text-lg"
          >
            &lt;
          </button>
          <span
            id="page-indicator"
            class="font-black italic text-2xl bg-black text-white px-6 py-2 rotate-[-2deg] shadow-lg"
            >PAGE 1</span
          >
          <button
            onclick="changePage('next')"
            class="gnu-btn gnu-btn-white px-4 py-2 text-lg"
          >
            &gt;
          </button>
          <button
            onclick="changePage('last')"
            class="gnu-btn gnu-btn-white px-4 py-2 text-lg"
          >
            &gt;|
          </button>
        </div>
      </main>
    </div>

    <div
      id="editor-modal"
      class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-[#ffcc00] border-[8px] border-black p-8 w-full max-w-lg shadow-[20px_20px_0px_0px_rgba(255,255,255,1)] relative overflow-y-auto max-h-[90vh]"
      >
        <button
          onclick="closeModal()"
          class="absolute top-4 right-4 text-4xl font-black hover:text-red-600"
        >
          &times;
        </button>

        <h2
          id="modal-title"
          class="text-5xl font-black italic mb-6 border-b-4 border-black pb-2"
        >
          EDIT DATA
        </h2>
        <input type="hidden" id="edit-id" />

        <div class="space-y-4">
          <div id="preview-container" class="hidden mb-4">
            <label class="font-black text-xs block text-red-600"
              >CURRENT COVER</label
            >
            <div
              class="border-[6px] border-red-600 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] bg-black"
            >
              <img
                id="edit-preview-img"
                src=""
                class="w-full h-48 object-cover opacity-90"
              />
            </div>
          </div>

          <div>
            <label class="font-black text-xs block">ARTIST</label>
            <input
              type="text"
              id="edit-artist"
              class="w-full border-4 border-black p-3 font-bold text-xl uppercase outline-none focus:bg-white"
            />
          </div>
          <div>
            <label class="font-black text-xs block">TITLE</label>
            <input
              type="text"
              id="edit-title"
              class="w-full border-4 border-black p-3 font-bold text-xl uppercase outline-none focus:bg-white"
            />
          </div>
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="font-black text-xs block">YEAR</label>
              <input
                type="number"
                id="edit-year"
                class="w-full border-4 border-black p-3 font-bold text-xl outline-none focus:bg-white"
              />
            </div>
            <div class="flex-1">
              <label class="font-black text-xs block">OWNER</label>
              <select
                id="edit-owner-select"
                class="w-full border-4 border-black p-3 font-bold text-xl outline-none focus:bg-white appearance-none rounded-none"
              ></select>
            </div>
            <div>
              <label class="block text-xs font-black mt-2"
                >LENT TO (BORROWER)</label
              >
              <select
                id="edit-lent-to"
                class="w-full bg-transparent border-2 border-black p-2 font-black"
              >
                <option value="">-- IN STOCK --</option>
              </select>
            </div>
          </div>
          <div>
            <label class="font-black text-xs block">UPDATE COVER ART</label>
            <input
              type="file"
              id="edit-cover"
              accept="image/*"
              class="w-full border-4 border-black p-2 bg-white font-bold text-sm"
            />
          </div>
        </div>

        <div class="mt-8 flex gap-4">
          <button
            onclick="saveAlbum()"
            onmousedown="playBeep(600,900)"
            class="gnu-btn gnu-btn-black flex-1 py-4 text-2xl"
          >
            SAVE DATA
          </button>
          <button
            onclick="deleteAlbum()"
            id="btn-delete"
            class="gnu-btn gnu-btn-red px-6 py-4 text-xl"
          >
            DEL
          </button>
        </div>

        <div
          id="import-section"
          class="mt-8 pt-6 border-t-4 border-black hidden"
        >
          <p
            class="font-black italic text-lg bg-black text-white px-2 inline-block mb-4"
          >
            BATCH IMPORT
          </p>

          <div class="flex gap-4 mb-4">
            <div class="flex-1">
              <label class="font-black text-xs block">TARGET OWNER</label>
              <select
                id="import-owner-select"
                class="w-full border-4 border-black p-2 font-bold outline-none"
              ></select>
            </div>
            <div class="flex-1">
              <label class="font-black text-xs block">SET YEAR</label>
              <input
                type="number"
                id="import-year"
                value="2024"
                class="w-full border-4 border-black p-2 font-bold outline-none"
              />
            </div>
          </div>

          <button
            onclick="document.getElementById('csv-upload').click()"
            class="gnu-btn gnu-btn-white w-full py-2 text-lg hover:bg-black hover:text-white mb-2"
          >
            üìÇ 1. SELECT CSV FILE
          </button>
          <input
            type="file"
            id="csv-upload"
            accept=".csv"
            class="hidden"
            onchange="doImport()"
          />
          <p class="text-xs font-bold text-center opacity-50">
            FILE WILL BE PROCESSED IMMEDIATELY UPON SELECTION
          </p>
        </div>
      </div>
    </div>

    <script>
      // Ê≥®ÊÑèÔºöÁôºÂ∏ÉÂà∞Á∂≤Ë∑ØÊôÇÔºåÈÄôË£°ÁöÑ localhost Ë¶ÅÊîπÊàê‰Ω†ÁöÑÈõªËÖ¶ IP ÊàñÂüüÂêç
      const API_URL = "http://localhost:5082/api/albums";
      const AUTH_URL = "http://localhost:5082/api/Account";
      const IMG_BASE = "http://localhost:5082/images/";
      let currentUser = "GUEST";
      let allAlbums = [];
      let allOwners = new Set();
      let currentPage = 1;
      const pageSize = 10;
      let isRegisterMode = false;

      // --- Èü≥ÊïàÂºïÊìé ---
      let audioCtx = null;

      function initAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
      }

      const makeDistortionCurve = (amount) => {
        const k = typeof amount === "number" ? amount : 50;
        const n_samples = 44100;
        const curve = new Float32Array(n_samples);
        const deg = Math.PI / 180;
        for (let i = 0; i < n_samples; ++i) {
          const x = (i * 2) / n_samples - 1;
          curve[i] = ((3 + k) * x * 20 * deg) / (Math.PI + k * Math.abs(x));
        }
        return curve;
      };

      const engines = {
        ethnic: (ctx, now, pitch = 300) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.frequency.setValueAtTime(pitch, now);
          osc.frequency.exponentialRampToValueAtTime(pitch * 0.5, now + 0.1);
          gain.gain.setValueAtTime(0.5, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          osc.stop(now + 0.2);
        },
        jazz: (ctx, now, subtype = "brush") => {
          const gain = ctx.createGain();
          if (subtype === "brush") {
            const bufferSize = ctx.sampleRate * 0.3;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++)
              data[i] = (Math.random() * 2 - 1) * 0.5;
            const noise = ctx.createBufferSource();
            noise.buffer = buffer;
            const filter = ctx.createBiquadFilter();
            filter.type = "bandpass";
            filter.frequency.value = 4000;
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            noise.connect(filter).connect(gain).connect(ctx.destination);
            noise.start();
          } else {
            const osc = ctx.createOscillator();
            const osc2 = ctx.createOscillator();
            osc.type = "square";
            osc2.type = "square";
            osc.frequency.value = 5000;
            osc2.frequency.value = 800;
            const ringGain = ctx.createGain();
            ringGain.gain.value = 1000;
            osc2.connect(ringGain).connect(osc.frequency);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
            osc.connect(gain).connect(ctx.destination);
            osc.start();
            osc2.start();
            osc.stop(now + 0.8);
            osc2.stop(now + 0.8);
          }
        },
        dj: (ctx, now) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "triangle";
          osc.frequency.setValueAtTime(400, now);
          osc.frequency.linearRampToValueAtTime(1200, now + 0.1);
          osc.frequency.linearRampToValueAtTime(200, now + 0.2);
          gain.gain.setValueAtTime(0.5, now);
          gain.gain.linearRampToValueAtTime(0, now + 0.25);
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          osc.stop(now + 0.25);
        },
        bass: (ctx, now, pitch = 55) => {
          const osc = ctx.createOscillator();
          const osc2 = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc2.type = "square";
          osc.frequency.value = pitch;
          osc2.frequency.value = pitch;
          const subGain = ctx.createGain();
          subGain.gain.value = 0.3;
          osc2.connect(subGain).connect(gain);
          osc.connect(gain);
          gain.gain.setValueAtTime(0.6, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
          gain.connect(ctx.destination);
          osc.start();
          osc2.start();
          osc.stop(now + 0.6);
          osc2.stop(now + 0.6);
        },
        guitar: (ctx, now, pitch = 110) => {
          const osc1 = ctx.createOscillator();
          const osc2 = ctx.createOscillator();
          osc1.type = "sawtooth";
          osc2.type = "sawtooth";
          osc1.frequency.value = pitch;
          osc2.frequency.value = pitch + 2;
          const distortion = ctx.createWaveShaper();
          distortion.curve = makeDistortionCurve(200);
          distortion.oversample = "4x";
          const filter = ctx.createBiquadFilter();
          filter.type = "lowpass";
          filter.frequency.value = 2000;
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(0.2, now);
          gain.gain.linearRampToValueAtTime(0, now + 0.8);
          osc1.connect(distortion).connect(filter).connect(gain);
          osc2.connect(distortion).connect(filter).connect(gain);
          gain.connect(ctx.destination);
          osc1.start();
          osc2.start();
          osc1.stop(now + 0.8);
          osc2.stop(now + 0.8);
        },
        piano: (ctx, now, pitch = 261.6) => {
          const osc = ctx.createOscillator();
          const osc2 = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc2.type = "triangle";
          osc.frequency.value = pitch;
          osc2.frequency.value = pitch;
          gain.gain.setValueAtTime(0.3, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
          osc.connect(gain);
          osc2.connect(gain);
          gain.connect(ctx.destination);
          osc.start();
          osc2.start();
          osc.stop(now + 1.2);
          osc2.stop(now + 1.2);
        },
        wind: (ctx, now, pitch = 300) => {
          const osc = ctx.createOscillator();
          const filter = ctx.createBiquadFilter();
          const gain = ctx.createGain();
          osc.type = "sawtooth";
          osc.frequency.value = pitch;
          filter.type = "lowpass";
          filter.frequency.setValueAtTime(200, now);
          filter.frequency.linearRampToValueAtTime(2000, now + 0.1);
          filter.frequency.exponentialRampToValueAtTime(500, now + 0.5);
          gain.gain.setValueAtTime(0, now);
          gain.gain.linearRampToValueAtTime(0.2, now + 0.05);
          gain.gain.linearRampToValueAtTime(0, now + 0.5);
          osc.connect(filter).connect(gain).connect(ctx.destination);
          osc.start();
          osc.stop(now + 0.5);
        },
        synth: (ctx, now, pitch = 440) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "square";
          osc.frequency.value = pitch;
          osc.frequency.setValueAtTime(pitch, now);
          osc.frequency.linearRampToValueAtTime(pitch + 10, now + 0.1);
          osc.frequency.linearRampToValueAtTime(pitch - 10, now + 0.2);
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.linearRampToValueAtTime(0, now + 0.3);
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          osc.stop(now + 0.3);
        },
        fx: (ctx, now, type = "laser") => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          if (type === "laser") {
            osc.type = "sawtooth";
            osc.frequency.setValueAtTime(1000, now);
            osc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
          } else {
            osc.type = "square";
            osc.frequency.setValueAtTime(Math.random() * 2000, now);
            osc.frequency.linearRampToValueAtTime(
              Math.random() * 500,
              now + 0.1
            );
          }
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.linearRampToValueAtTime(0, now + 0.15);
          osc.connect(gain).connect(ctx.destination);
          osc.start();
          osc.stop(now + 0.15);
        },
      };

      const generateKeyMapping = () => {
        const keys = "1234567890QWERTYUIOPASDFGHJKLZXCVBNM".split("");
        const types = [
          { id: "ethnic" },
          { id: "jazz" },
          { id: "dj" },
          { id: "bass" },
          { id: "guitar" },
          { id: "piano" },
          { id: "wind" },
          { id: "synth" },
          { id: "fx" },
        ];
        const map = {};
        const notes = [
          130.8, 146.8, 164.8, 174.6, 196.0, 220.0, 246.9, 261.6, 293.7, 329.6,
          349.2, 392.0,
        ];
        const shuffledTypes = [];
        while (shuffledTypes.length < keys.length)
          shuffledTypes.push(types[Math.floor(Math.random() * types.length)]);
        keys.forEach((key, index) => {
          const selectedType = shuffledTypes[index];
          const pitch =
            notes[Math.floor(Math.random() * notes.length)] *
            (Math.random() > 0.5 ? 1 : 2);
          map[key] = {
            engine: selectedType.id,
            params: { pitch, subtype: Math.random() > 0.5 ? "brush" : "ride" },
          };
        });
        map["SPACE"] = { engine: "fx", params: { type: "laser" } };
        return map;
      };

      const keyMapping = generateKeyMapping();

      const triggerSound = (key) => {
        let processedKey = key.toUpperCase();
        if (key === " ") processedKey = "SPACE";

        // üî• ‰øÆÊîπÔºöÁßªÈô§‰∫ÜÊ™¢Êü•Ëº∏ÂÖ•Ê°ÜÁöÑÈÇèËºØÔºåÁèæÂú®ÁÑ°Ë´ñÂú®Âì™ÊâìÂ≠óÈÉΩÊúÉÊúâËÅ≤Èü≥
        // Âè™Ë¶ÅÈçµÁõ§ÊúâÂ∞çÊáâÂà∞ËÅ≤Èü≥Â∫´ÔºåÂ∞±ÊúÉÊí≠Êîæ
        if (!keyMapping[processedKey]) return;

        initAudio();
        const ctx = audioCtx;
        const now = ctx.currentTime;
        const soundData = keyMapping[processedKey];

        if (soundData.engine === "ethnic")
          engines.ethnic(ctx, now, soundData.params.pitch);
        else if (soundData.engine === "jazz")
          engines.jazz(ctx, now, soundData.params.subtype);
        else if (soundData.engine === "dj") engines.dj(ctx, now);
        else if (soundData.engine === "bass")
          engines.bass(ctx, now, soundData.params.pitch / 2);
        else if (soundData.engine === "guitar")
          engines.guitar(ctx, now, soundData.params.pitch);
        else if (soundData.engine === "piano")
          engines.piano(ctx, now, soundData.params.pitch);
        else if (soundData.engine === "wind")
          engines.wind(ctx, now, soundData.params.pitch);
        else if (soundData.engine === "synth")
          engines.synth(ctx, now, soundData.params.pitch);
        else if (soundData.engine === "fx")
          engines.fx(ctx, now, Math.random() > 0.5 ? "laser" : "glitch");
      };

      window.addEventListener("keydown", (e) => {
        if (!e.repeat) triggerSound(e.key);
      });

      const cursor = document.getElementById("custom-cursor");
      document.addEventListener("mousemove", (e) => {
        cursor.style.left = e.clientX + "px";
        cursor.style.top = e.clientY + "px";
      });

      const playBeep = (f1, f2) => {
        try {
          initAudio();
          const ctx = audioCtx;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = "square";
          const now = ctx.currentTime;
          osc.frequency.setValueAtTime(f1, now);
          osc.frequency.exponentialRampToValueAtTime(f2, now + 0.1);
          gain.gain.setValueAtTime(0.1, now);
          gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
          osc.start(now);
          osc.stop(now + 0.1);
        } catch (e) {}
      };

      function showAlert(msg, type = "normal") {
        return new Promise((resolve) => {
          const overlay = document.getElementById("custom-alert-overlay");
          const box = document.getElementById("alert-box-content");
          const title = document.getElementById("alert-title");
          const message = document.getElementById("alert-msg");
          const actions = document.getElementById("alert-actions");

          overlay.classList.remove("hidden");
          message.innerText = msg;

          actions.innerHTML = `<button id="alert-ok-btn" class="gnu-btn px-6 py-2 text-xl shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">OK</button>`;

          if (type === "error") {
            box.className =
              "alert-box border-[6px] border-white shadow-[20px_20px_0px_0px_rgba(255,255,255,0.2)] max-w-md w-full p-8 text-center relative bg-[#dc2626] text-white";
            title.innerText = "‚ö†Ô∏è WARNING";
            title.className =
              "text-5xl font-black italic mb-4 uppercase text-white tracking-tighter";
            document.getElementById("alert-ok-btn").className =
              "gnu-btn bg-black text-white px-8 py-3 text-2xl hover:bg-white hover:text-red-600";
            playBeep(150, 100);
          } else {
            box.className =
              "alert-box border-[6px] border-black shadow-[20px_20px_0px_0px_rgba(0,0,0,1)] max-w-sm w-full p-8 text-center relative bg-white text-black";
            title.innerText = "SYSTEM INFO";
            title.className =
              "text-3xl font-black italic mb-4 uppercase text-black bg-[#ffcc00] inline-block px-2";
            document.getElementById("alert-ok-btn").className =
              "gnu-btn gnu-btn-black px-6 py-2 text-xl";
            playBeep(800, 1200);
          }

          document.getElementById("alert-ok-btn").onclick = () => {
            overlay.classList.add("hidden");
            resolve();
          };
        });
      }

      function showConfirm(msg) {
        return new Promise((resolve) => {
          const overlay = document.getElementById("custom-alert-overlay");
          const box = document.getElementById("alert-box-content");
          const title = document.getElementById("alert-title");
          const message = document.getElementById("alert-msg");
          const actions = document.getElementById("alert-actions");

          overlay.classList.remove("hidden");
          message.innerText = msg;

          box.className =
            "alert-box border-[6px] border-black shadow-[20px_20px_0px_0px_rgba(0,0,0,1)] max-w-sm w-full p-8 text-center relative bg-white";
          title.innerText = "DECISION REQUIRED";
          title.className =
            "text-2xl font-black italic mb-4 uppercase text-white bg-black px-2 inline-block";

          actions.innerHTML = `
                    <button id="confirm-yes" class="gnu-btn gnu-btn-red px-6 py-2 text-lg">YES</button>
                    <button id="confirm-no" class="gnu-btn gnu-btn-white px-6 py-2 text-lg">NO</button>
                `;

          playBeep(600, 600);

          document.getElementById("confirm-yes").onclick = () => {
            overlay.classList.add("hidden");
            resolve(true);
          };
          document.getElementById("confirm-no").onclick = () => {
            overlay.classList.add("hidden");
            resolve(false);
          };
        });
      }

      function toggleAuthMode() {
        isRegisterMode = !isRegisterMode;
        const title = document.getElementById("auth-title");
        const toggleText = document.getElementById("auth-toggle-text");
        const toggleBtn = event.target;
        if (isRegisterMode) {
          title.innerText = "REGISTER";
          toggleText.innerText = "ALREADY MEMBER?";
          toggleBtn.innerText = "LOGIN HERE";
        } else {
          title.innerText = "LOGIN";
          toggleText.innerText = "NEW HERE?";
          toggleBtn.innerText = "CREATE ACCOUNT";
        }
      }

      async function handleAuth() {
        const nick = document.getElementById("nickname-input").value.trim();
        const pass = document.getElementById("password-input").value.trim();
        if (!nick) {
          await showAlert("ACCESS DENIED: NICKNAME REQUIRED", "error");
          return;
        }
        if (!pass) {
          await showAlert("ACCESS DENIED: PASSWORD REQUIRED", "error");
          return;
        }

        const payload = { Nickname: nick, Password: pass, Email: "" };
        const endpoint = isRegisterMode
          ? `${AUTH_URL}/Register`
          : `${AUTH_URL}/Login`;

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (res.ok) {
            if (isRegisterMode) {
              await showAlert("REGISTRATION SUCCESS: PLEASE LOGIN", "normal");
              toggleAuthMode();
            } else {
              loginSuccess(nick);
            }
          } else {
            let errorMsg = "AUTH FAILED";
            if (data.Message) errorMsg = data.Message;
            else if (Array.isArray(data)) errorMsg = data[0].description;
            await showAlert(`ERROR: ${errorMsg}`, "error");
          }
        } catch (err) {
          await showAlert("SYSTEM ERROR: CANNOT CONNECT TO SERVER", "error");
        }
      }

      function loginSuccess(nick) {
        currentUser = nick.toUpperCase();
        document.getElementById(
          "user-display"
        ).innerText = `USER: ${currentUser}`;
        document.getElementById("login-page").classList.add("hidden");
        document.getElementById("main-page").classList.remove("hidden");
        initAudio();
        resetAndFetch();
      }

      function logout() {
        location.reload();
      }

      async function resetAndFetch() {
        currentPage = 1;
        await fetchAlbums();
      }

      async function fetchAlbums() {
        const keyword = document.getElementById("search-input").value;
        const ownerFilter = document.getElementById(
          "search-owner-select"
        ).value;
        let url = API_URL + "?";
        if (keyword) url += `search=${encodeURIComponent(keyword)}&`;
        if (ownerFilter !== "ALL")
          url += `owner=${encodeURIComponent(ownerFilter)}`;

        try {
          const res = await fetch(url);
          allAlbums = await res.json();
          updateOwnerDropdowns(allAlbums);
          renderTable();
        } catch (err) {
          console.error(err);
          await showAlert("CONNECTION FAILED: SERVER OFFLINE", "error");
        }
      }

      function updateOwnerDropdowns(albums) {
        albums.forEach((a) => {
          if (a.owner) allOwners.add(a.owner);
        });
        if (currentUser !== "GUEST") allOwners.add(currentUser);
        const sortedOwners = Array.from(allOwners).sort();

        // 1. Êõ¥Êñ∞ÊêúÂ∞ãÂàó
        const searchSelect = document.getElementById("search-owner-select");
        const currentSearch = searchSelect.value;
        searchSelect.innerHTML = `<option value="ALL">ALL USERS</option>`;
        sortedOwners.forEach((owner) => {
          searchSelect.innerHTML += `<option value="${owner}">${owner}</option>`;
        });
        searchSelect.value = currentSearch;

        // 2. Êõ¥Êñ∞Á∑®ËºØÊ°Ü
        const editSelect = document.getElementById("edit-owner-select");
        editSelect.innerHTML = "";
        sortedOwners.forEach((owner) => {
          editSelect.innerHTML += `<option value="${owner}">${owner}</option>`;
        });

        // 3. üî• Êõ¥Êñ∞ÂåØÂÖ•Ê°Ü (Êñ∞Â¢ûÁöÑÈÉ®ÂàÜ)
        const importSelect = document.getElementById("import-owner-select");
        importSelect.innerHTML = "";
        sortedOwners.forEach((owner) => {
          importSelect.innerHTML += `<option value="${owner}">${owner}</option>`;
        });
        if (currentUser !== "GUEST") importSelect.value = currentUser; // È†êË®≠ÈÅ∏Ëá™Â∑±
      }

      function renderTable() {
        const tbody = document.getElementById("album-tbody");
        tbody.innerHTML = "";
        const totalPages = Math.ceil(allAlbums.length / pageSize) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        document.getElementById(
          "page-indicator"
        ).innerText = `PAGE ${currentPage} / ${totalPages}`;
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;

        allAlbums.slice(start, end).forEach((a) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td class="font-black text-xl">#${a.localId}</td>
                    <td><div class="w-12 h-12 bg-gray-200 border-2 border-black overflow-hidden"><img src="${
                      a.coverFileName
                        ? IMG_BASE + a.coverFileName
                        : "https://placehold.jp/150x150.png"
                    }" class="w-full h-full object-cover"></div></td>
                    <td><div class="text-xl font-black italic uppercase">${
                      a.title
                    }</div><div class="text-sm text-red-600 font-bold">${
            a.artist
          }</div></td>
                    <td class="text-lg italic">${a.releaseYear}</td>
                    <td><span class="bg-black text-white px-2 text-xs">${
                      a.owner
                    }</span></td>
                    <td class="text-right"><button onclick='openModal("edit", ${JSON.stringify(
                      a
                    ).replace(
                      /'/g,
                      "&#39;"
                    )})' class="border-2 border-black px-3 py-1 hover:bg-black hover:text-[#ffcc00] font-black transition">EDIT</button></td>
                `;
          tbody.appendChild(tr);
        });
      }

      function changePage(action) {
        const totalPages = Math.ceil(allAlbums.length / pageSize) || 1;
        if (action === "first") currentPage = 1;
        if (action === "prev" && currentPage > 1) currentPage--;
        if (action === "next" && currentPage < totalPages) currentPage++;
        if (action === "last") currentPage = totalPages;
        playBeep(400, 300);
        renderTable();
      }

      function openModal(mode, data = null) {
        const modal = document.getElementById("editor-modal");
        const title = document.getElementById("modal-title");
        const btnDel = document.getElementById("btn-delete");
        const ownerSelect = document.getElementById("edit-owner-select");
        const importSection = document.getElementById("import-section");
        const previewContainer = document.getElementById("preview-container");
        const previewImg = document.getElementById("edit-preview-img");
        const lentToSelect = document.getElementById("edit-lent-to"); // üëà 1. ÂèñÂæóÂÄüÁî®ËÄÖ‰∏ãÊãâÈÅ∏ÂñÆ
        document.getElementById("edit-cover").value = "";
        modal.classList.remove("hidden");

        if (mode === "create") {
          title.innerText = "NEW ENTRY";
          btnDel.classList.add("hidden");
          importSection.classList.remove("hidden");
          previewContainer.classList.add("hidden");

          document.getElementById("edit-id").value = "";
          document.getElementById("edit-artist").value = "";
          document.getElementById("edit-title").value = "";
          document.getElementById("edit-year").value = "2024";
          ownerSelect.value = currentUser;
        } else {
          title.innerText = "EDIT DATA";
          btnDel.classList.remove("hidden");
          importSection.classList.add("hidden");

          document.getElementById("edit-id").value = data.id;
          document.getElementById("edit-artist").value = data.artist;
          document.getElementById("edit-title").value = data.title;
          document.getElementById("edit-year").value = data.releaseYear;
          ownerSelect.value = data.owner;

          if (data.coverFileName) {
            previewImg.src = IMG_BASE + data.coverFileName;
            previewContainer.classList.remove("hidden");
          } else {
            previewContainer.classList.add("hidden");
          }
        }
      }

      function closeModal() {
        document.getElementById("editor-modal").classList.add("hidden");
      }

      async function saveAlbum() {
        const id = document.getElementById("edit-id").value;
        const artist = document.getElementById("edit-artist").value;
        const title = document.getElementById("edit-title").value;
        const year = document.getElementById("edit-year").value;
        const owner = document.getElementById("edit-owner-select").value;
        const lentTo = document.getElementById("edit-lent-to").value; // üëà 1. ÂèñÂæóÂÄüÁî®ËÄÖ
        const fileInput = document.getElementById("edit-cover");

        if (!artist || !title) {
          await showAlert("VALIDATION ERROR: FIELDS MISSING", "error");
          return;
        }

        const formData = new FormData();
        formData.append("Artist", artist);
        formData.append("Title", title);
        formData.append("ReleaseYear", year);
        formData.append("Owner", owner);
        formData.append("LentTo", lentTo); // üëà 2. Âä†ÂÖ•ÂÄüÁî®ËÄÖË≥áÊñô
        if (fileInput.files[0])
          formData.append("CoverImage", fileInput.files[0]);

        let url = API_URL;
        let method = "POST";
        if (id) {
          url += `/${id}`;
          method = "PUT";
          // ‰∏çÈúÄË¶ÅÊâãÂãï append IdÔºåÂõ†ÁÇ∫ id Â∑≤Á∂ìÂú® URL Ë£°‰∫Ü
        }

        try {
          const res = await fetch(url, {
            method: method,
            body: formData,
            // üëà 3. ÈáçË¶ÅÔºöÂä†‰∏äÊ¨äÈôêÊ™¢Êü•Áî®ÁöÑ Header
            headers: {
              "X-Current-User": currentUser,
            },
          });

          if (res.ok) {
            closeModal();
            await showAlert("DATA SAVED SUCCESSFULLY", "normal");
            resetAndFetch();
          } else {
            // ÂòóË©¶Ëß£ÊûêÂæåÁ´ØÂÇ≥ÂõûÁöÑÂÖ∑È´îÈåØË™§Ë®äÊÅØ
            const errorData = await res.json();
            await showAlert(
              `SAVE FAILED: ${errorData.message || "DATABASE ERROR"}`,
              "error"
            );
          }
        } catch (e) {
          console.error(e);
          await showAlert("NETWORK ERROR", "error");
        }
      }

      async function deleteAlbum() {
        const id = document.getElementById("edit-id").value;
        const confirmed = await showConfirm("PERMANENT DELETE? CANNOT UNDO.");
        if (!confirmed) return;

        try {
          const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
          if (res.ok) {
            closeModal();
            await showAlert("RECORD DELETED", "normal");
            resetAndFetch();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function doImport() {
        const fileInput = document.getElementById("csv-upload");
        const targetOwner = document.getElementById(
          "import-owner-select"
        ).value;
        const targetYear = document.getElementById("import-year").value;

        if (!fileInput.files[0]) return;

        // üî• Â¢ûÂä†ÔºöÁ¢∫Ë™çË¶ñÁ™ó
        const confirmed = await showConfirm(
          `PLEASE CONFIRM IMPORT:\n\nOWNER: ${targetOwner}\nYEAR: ${targetYear}\n\nPROCEED?`
        );
        if (!confirmed) {
          fileInput.value = ""; // Ê∏ÖÁ©∫ÈÅ∏Êìá
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        // üî• Â∞áÈÅ∏ÊìáÁöÑË≥áÊñôÂÇ≥Áµ¶ÂæåÁ´Ø
        formData.append("owner", targetOwner);
        formData.append("year", targetYear);

        playBeep(1000, 2000);
        try {
          const res = await fetch(`${API_URL}/Import`, {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (res.ok) {
            closeModal();
            await showAlert(`BATCH IMPORT COMPLETE\n${data.Message}`, "normal");
            resetAndFetch();
          } else {
            await showAlert("IMPORT ERROR: FILE INVALID", "error");
          }
        } catch (err) {
          await showAlert("SYSTEM ERROR", "error");
        }
        fileInput.value = "";
      }
    </script>
  </body>
</html>
